<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Full Dashboard - Medicare</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="user-header">
      <span id="welcomeMessage"></span>
      <a href="/logout" class="logout-btn">Logout</a>
    </div>
    <h1>Exercise History Dashboard</h1>
    <div class="controls">
      <ul id="dashboardFullList"></ul>
    </div>
    <button onclick="window.location.href='/exercise_dashboard'">
      Back to My Exercises
    </button>
    <script>
      fetch("/api/user")
        .then((r) => r.json())
        .then((data) => {
          document.getElementById(
            "welcomeMessage"
          ).textContent = `Welcome, ${data.username}`;
        });

      fetch("/api/full_dashboard_data")
        .then((r) => r.json())
        .then((data) => {
          const list = document.getElementById("dashboardFullList");
          list.innerHTML = "";
          data.exercises.forEach((ex) => {
            const exName = ex.name;
            if (ex.analysis_history && ex.analysis_history.length > 0) {
              ex.analysis_history.forEach((record) => {
                const li = document.createElement("li");
                li.innerHTML = `<strong>${exName}</strong> <span style="color:#555;">(${new Date(
                  record.performed_at
                ).toLocaleString()})</span>
                <button class="view-btn">View Analysis</button>
                <button class="view-btn" onclick="window.open('/models/${
                  record.raw_file
                }','_blank')">Download Raw Data</button>`;
                li.querySelector(".view-btn").onclick = function () {
                  fetch("/api/select_analysis", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                      analysis_file: record.analysis_file,
                      name: exName,
                      performed_at: record.performed_at,
                    }),
                  }).then(() => {
                    window.location.href = "/exercise_analysis";
                  });
                };
                list.appendChild(li);
              });
            }
          });
        });
    </script>
  </body>
</html>
