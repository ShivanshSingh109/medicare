<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Exercise History Dashboard - Medicare</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='auth.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='profile.css') }}"
    />
    <style>
      body {
        background: #e5e5f7;
      }
      .dashboard-container {
        display: flex;
        max-width: 1200px;
        margin: 40px auto;
        background: #fff;
        border: 1px solid #e2e2e2;
        box-shadow: 0 4px 24px rgba(40, 44, 52, 0.08);
        border-radius: 0;
        min-height: 600px;
      }
      .dashboard-list {
        width: 320px;
        border-right: 1px solid #e2e2e2;
        padding: 32px 0 32px 32px;
        background: #f7f7fa;
        overflow-y: auto;
      }
      .dashboard-list h2 {
        font-size: 22px;
        margin-bottom: 18px;
        color: #2d3748;
      }
      .exercise-list-item {
        padding: 16px 12px;
        border-bottom: 1px solid #e2e2e2;
        cursor: pointer;
        transition: background 0.2s;
        color: #2d3748;
      }
      .exercise-list-item:last-child {
        border-bottom: none;
      }
      .exercise-list-item.active,
      .exercise-list-item:hover {
        background: #e5e5f7;
        font-weight: 600;
      }
      .dashboard-content {
        flex: 1;
        padding: 32px;
        min-height: 600px;
        background: #fff;
      }
      .dashboard-tile {
        background: #fff;
        border-radius: 0;
        box-shadow: 0 2px 8px rgba(40, 44, 52, 0.07);
        border: 1px solid #e2e2e2;
        color: #2d3748;
        margin-bottom: 18px;
        padding: 18px 14px;
      }
      .dashboard-tile strong {
        font-size: 18px;
        margin-bottom: 6px;
      }
      .dashboard-tile .date {
        font-size: 13px;
        color: #59433b;
        margin-bottom: 10px;
      }
      .dashboard-tile .tile-btns {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      .auth-btn {
        margin-top: 10px;
        margin-bottom: 0;
      }
      .analysis-result,
      .progress-result {
        margin-top: 18px;
        font-size: 16px;
        color: #222;
      }
    </style>
  </head>
  <body>
    <div class="user-header">
      <span id="welcomeMessage"></span>
      <a href="/logout" class="logout-btn">Logout</a>
    </div>
    <div class="dashboard-container">
      <div class="dashboard-list">
        <h2>Your Exercises</h2>
        <div id="exerciseList"></div>
      </div>
      <div class="dashboard-content">
        <div id="dashboardDetails">
          <p>Select an exercise and action to view details.</p>
        </div>
      </div>
    </div>
    <button
      id="backToExerciseDashboardBtn"
      class="auth-btn"
      style="margin: 32px auto 0 auto; display: block; max-width: 320px"
    >
      Back to Patient Exercises
    </button>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      fetch("/api/user")
        .then((r) => r.json())
        .then((data) => {
          document.getElementById(
            "welcomeMessage"
          ).textContent = `Welcome, ${data.username}`;
        });

      let allExercises = [];
      let selectedExerciseIdx = null;
      let selectedAnalysisIdx = null;

      function renderExerciseList() {
        const list = document.getElementById("exerciseList");
        list.innerHTML = "";
        allExercises.forEach((ex, idx) => {
          const displayName = ex.display_name || ex.name;
          const div = document.createElement("div");
          div.className =
            "exercise-list-item" +
            (selectedExerciseIdx === idx ? " active" : "");
          div.textContent = displayName;
          div.onclick = function () {
            selectedExerciseIdx = idx;
            selectedAnalysisIdx = null;
            renderExerciseList();
            renderExerciseDetails();
          };
          list.appendChild(div);
        });
      }

      function renderExerciseDetails() {
        const details = document.getElementById("dashboardDetails");
        details.innerHTML = "";
        if (selectedExerciseIdx === null) {
          details.innerHTML = "<p>Select an exercise to view details.</p>";
          return;
        }
        const ex = allExercises[selectedExerciseIdx];
        const displayName = ex.display_name || ex.name;
        details.innerHTML = `<h2>${displayName}</h2>`;
        if (ex.analysis_history && ex.analysis_history.length > 0) {
          ex.analysis_history.forEach((record, idx) => {
            const tile = document.createElement("div");
            tile.className = "dashboard-tile";
            tile.innerHTML = `
              <strong>${displayName}</strong>
              <span class="date">${new Date(
                record.performed_at
              ).toLocaleString()}</span>
              <div class="tile-btns">
                <button class="view-btn auth-btn" style="padding:7px 14px;">View Analysis</button>
                <button class="progress-btn auth-btn" style="padding:7px 14px;">Progress Report</button>
              </div>
              <div class="analysis-result" id="analysisResult${idx}" style="display:none;"></div>
              <div class="progress-result" id="progressResult${idx}" style="display:none;"></div>
            `;
            // View Analysis button
            tile.querySelector(".view-btn").onclick = function () {
              // Fetch analysis and show in right panel
              fetch("/api/select_analysis", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  analysis_file: record.analysis_file,
                  name: ex.name,
                  performed_at: record.performed_at,
                }),
              }).then(() => {
                fetch("/api/analysis_data")
                  .then((r) => r.json())
                  .then((data) => {
                    const resultDiv = tile.querySelector(
                      `#analysisResult${idx}`
                    );
                    resultDiv.style.display = "block";
                    tile.querySelector(`#progressResult${idx}`).style.display =
                      "none";
                    if (data.error) {
                      resultDiv.innerHTML = `<div class="error">${data.error}</div>`;
                      return;
                    }
                    const a = data.analysis;
                    let html = "";
                    html += `<strong>Form & Correctness:</strong> ${
                      a.form_correctness || ""
                    }<br><br>`;
                    html += `<strong>Consistency:</strong> ${
                      a.consistency || ""
                    }<br><br>`;
                    html += `<strong>Speed & Pacing:</strong> ${
                      a.speed_pacing || ""
                    }<br><br>`;
                    html += `<strong>Corrective Feedback:</strong> ${
                      a.corrective_feedback || ""
                    }<br><br>`;
                    html += `<strong>Overall Summary:</strong> ${
                      a.overall_summary || ""
                    }`;
                    resultDiv.innerHTML = html;
                  });
              });
            };
            // Progress Report button
            tile.querySelector(".progress-btn").onclick = function () {
              // Fetch progress report and show in right panel
              fetch("/api/exercise_progress_report", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: ex.name }),
              })
                .then((r) => r.json())
                .then((reportData) => {
                  const resultDiv = tile.querySelector(`#progressResult${idx}`);
                  resultDiv.style.display = "block";
                  tile.querySelector(`#analysisResult${idx}`).style.display =
                    "none";
                  resultDiv.innerHTML = reportData.error
                    ? `<div class="error">${reportData.error}</div>`
                    : `<div style="margin-bottom:20px;">${
                        reportData.progress_report || reportData.report
                      }</div>
                         <div>
                           <canvas id="bar_${displayName.replace(
                             /[^a-zA-Z0-9]/g,
                             ""
                           )}" width="340" height="200" style="max-width:340px;max-height:200px;"></canvas>
                         </div>`;
                  if (
                    reportData.pie_chart_data &&
                    Object.keys(reportData.pie_chart_data).length > 0
                  ) {
                    const ctxBar = document
                      .getElementById(
                        `bar_${displayName.replace(/[^a-zA-Z0-9]/g, "")}`
                      )
                      .getContext("2d");
                    new Chart(ctxBar, {
                      type: "bar",
                      data: {
                        labels: Object.keys(reportData.pie_chart_data),
                        datasets: [
                          {
                            label: "Feedback Distribution",
                            data: Object.values(reportData.pie_chart_data),
                            backgroundColor: [
                              "#b0b0b0",
                              "#888",
                              "#ccc",
                              "#444",
                              "#222",
                            ],
                            maxBarThickness: 40,
                          },
                        ],
                      },
                      options: {
                        indexAxis: "y",
                        plugins: {
                          legend: { display: false },
                        },
                        scales: {
                          x: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: "Percentage (%)" },
                          },
                          y: {
                            title: { display: false },
                          },
                        },
                        responsive: false,
                      },
                    });
                  }
                });
            };
            details.appendChild(tile);
          });
        } else {
          details.innerHTML += "<p>No analysis history for this exercise.</p>";
        }
      }

      fetch("/api/full_dashboard_data")
        .then((r) => r.json())
        .then((data) => {
          allExercises = data.exercises || [];
          renderExerciseList();
          renderExerciseDetails();
        });

      document.getElementById("backToExerciseDashboardBtn").onclick =
        function () {
          window.location.href = "/exercise_dashboard";
        };
    </script>
  </body>
</html>
